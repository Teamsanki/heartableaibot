from flask import Flask, request
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager
import time, os, requests

app = Flask(__name__)
BOT_TOKEN = os.getenv("BOT_TOKEN")
TELEGRAM_CHAT_ID = os.getenv("CHAT_ID")
LOGGER_GROUP_ID = os.getenv("LOGGER_GROUP_ID", TELEGRAM_CHAT_ID)  # Optional logger group

WELCOME_MSG_TEMPLATE = (
    "â¤ï¸â€ğŸ”¥ *á´¡á´‡ÊŸá´„á´á´á´‡ á´›á´ Êœá´‡á´€Ê€á´›á´€Ê™ÊŸá´‡ á´€Éª, {name}* â¤ï¸â€ğŸ”¥\n\n"
    "â•­â”â”â”â”³â”â”â”â”³â”â”â”â•®\n"
    "â”ƒğŸ’¬ sá´á´€Ê€á´› á´„Êœá´€á´›\n"
    "â”ƒğŸ¥ á´ Éªá´…á´‡á´ É¢á´‡É´á´‡Ê€á´€á´›á´Ê€\n"
    "â”ƒğŸ“– Éªá´…á´‡á´€s á´€á´…á´…á´€\n"
    "â”ƒğŸ–¼ á´€Éª Éªá´á´€É¢á´‡ É¢á´‡É´á´‡Ê€á´€á´›á´Ê€\n"
    "â•°â”â”â”â”â”»â”â”â”â”â”»â”â”â”â”â•¯\n\n"
    "âœ¨ á´…Éªá´ á´‡ ÉªÉ´á´›á´ á´€ á´¡á´Ê€ÊŸá´… á´¡Êœá´‡Ê€á´‡ Êœá´‡á´€Ê€á´›s sá´˜á´‡á´€á´‹.\n"
    "ğŸ’Œ ÊŸá´‡á´› Êá´á´œÊ€ á´‡á´á´á´›Éªá´É´s Ò“ÊŸá´á´¡ á´¡Éªá´›Êœ Êœá´‡á´€Ê€á´›á´€Ê™ÊŸá´‡ á´€Éª.\n\n"
    "ğŸ“Œ *Available Commands:*\n"
    "â€¢ `/chat` â€“ Smart Chat\n"
    "â€¢ `/video` â€“ AI Video Generator\n"
    "â€¢ `/image` â€“ AI Image Generator\n\n"
    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    "ğŸ‘‘ *á´á´¡É´á´‡Ê€:* [sá´€É´á´‹Éª](tg://user?id=7549407961)\n"
    "*á´ ÉªsÉªá´› É´á´á´¡:* [Êœá´‡á´€Ê€á´›á´€Ê™ÊŸá´‡ á´€Éª](https://www.heartable.site)\n"
    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
)

@app.route("/start", methods=["POST"])
def start():
    data = request.json or {}
    user = data.get("from", {})
    name = user.get("first_name", "User")
    username = user.get("username", "unknown")
    user_id = user.get("id", "0")

    welcome_caption = WELCOME_MSG_TEMPLATE.format(name=name)

    photo_url = "https://graph.org/file/3afe8fb057b85cfb7ab81-d7fad6cbb095587f2e.jpg"  # Example welcome image
    payload = {
        "chat_id": user_id,
        "photo": photo_url,
        "caption": welcome_caption,
        "parse_mode": "Markdown"
    }
    requests.post(f"https://api.telegram.org/bot{BOT_TOKEN}/sendPhoto", data=payload)

    # Log to group
    logger_text = f"ğŸ‘¤ New User Started Bot:\nğŸ†” ID: `{user_id}`\nğŸ‘¤ Name: {name}\nğŸ”— Username: @{username}"
    requests.post(f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage", data={
        "chat_id": LOGGER_GROUP_ID,
        "text": logger_text,
        "parse_mode": "Markdown"
    })

    return {"status": "sent"}, 200

@app.route("/generate", methods=["POST"])
def gen():
    data = request.json or {}
    prompt = data.get("prompt", "").strip()
    user = data.get("from", {})
    name = user.get("first_name", "User")
    username = user.get("username", "unknown")
    user_id = user.get("id", TELEGRAM_CHAT_ID)

    if not prompt or not BOT_TOKEN:
        return {"error": "prompt/BOT_TOKEN missing"}, 400

    start = time.time()
    opts = Options()
    opts.add_argument("--headless")
    opts.add_argument("--disable-gpu")
    opts.add_argument("--no-sandbox")
    driver = webdriver.Chrome(ChromeDriverManager().install(), options=opts)

    try:
        url = f"https://www.pollitions.ai/?prompt={prompt.replace(' ','%20')}"
        driver.get(url)
        time.sleep(12)
        path = "/tmp/out.png"
        driver.save_screenshot(path)
        elapsed = round(time.time() - start, 2)
        caption = f"ğŸ–¼ Image ready in {elapsed}s\nPrompt: {prompt}"

        with open(path, "rb") as f:
            resp = requests.post(
                f"https://api.telegram.org/bot{BOT_TOKEN}/sendPhoto",
                data={"chat_id": user_id, "caption": caption},
                files={"photo": f}
            )

        # Log to group
        log_msg = (
            "ğŸ“¤ *Image Generated by User:*
"
            f"ğŸ§‘â€ğŸ’» *Name:* {name}
"
            f"ğŸ”— *Username:* @{username}
"
            f"ğŸ†” *ID:* `{user_id}`
"
            f"ğŸ–¼ *Prompt:* `{prompt}`"
        )
        requests.post(f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage", data={
            "chat_id": LOGGER_GROUP_ID,
            "text": log_msg,
            "parse_mode": "Markdown"
        })

        return {"telegram": resp.json()}, 200
    finally:
        driver.quit()

@app.route("/health")
def health():
    return "OK", 200

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000)
